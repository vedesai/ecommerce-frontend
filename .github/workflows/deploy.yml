# AI Generated Code by Deloitte + Cursor (BEGIN)
name: Frontend CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  AWS_REGION: us-east-1
  PROJECT_NAME: crest-thread
  NODE_VERSION: '20'

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint || true

      - name: Run tests with coverage
        run: npm run test -- --coverage --watchAll=false || npm run test:coverage || true

      - name: Build application
        env:
          VITE_API_BASE_URL: ${{ vars.API_BASE_URL || 'http://localhost:8080/api' }}
          VITE_APP_ENV: ${{ github.event.inputs.environment || 'dev' }}
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: dist
          retention-days: 7

  deploy:
    name: Deploy to AWS
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: dist

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to S3
        env:
          ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}
        run: |
          BUCKET_NAME="${{ env.PROJECT_NAME }}-${ENVIRONMENT}-frontend-${{ secrets.AWS_ACCOUNT_ID }}"
          
          # Sync all files except index.html with long cache
          aws s3 sync dist/ s3://${BUCKET_NAME}/ \
            --delete \
            --cache-control "public, max-age=31536000" \
            --exclude "index.html" \
            --exclude "*.json"
          
          # Sync index.html with no-cache
          aws s3 cp dist/index.html s3://${BUCKET_NAME}/ \
            --cache-control "no-cache, no-store, must-revalidate"
          
          # Sync JSON files with short cache
          aws s3 sync dist/ s3://${BUCKET_NAME}/ \
            --exclude "*" \
            --include "*.json" \
            --cache-control "public, max-age=3600"

      - name: Invalidate CloudFront cache
        env:
          ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}
        run: |
          DISTRIBUTION_ID=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.PROJECT_NAME }}-${ENVIRONMENT}-frontend \
            --query "Stacks[0].Outputs[?OutputKey=='CloudFrontDistributionId'].OutputValue" \
            --output text 2>/dev/null || echo "")
          
          if [ -n "$DISTRIBUTION_ID" ] && [ "$DISTRIBUTION_ID" != "None" ]; then
            aws cloudfront create-invalidation \
              --distribution-id $DISTRIBUTION_ID \
              --paths "/*"
            echo "CloudFront cache invalidated"
          else
            echo "No CloudFront distribution found, skipping invalidation"
          fi

      - name: Deployment summary
        env:
          ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}
        run: |
          FRONTEND_URL=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.PROJECT_NAME }}-${ENVIRONMENT}-frontend \
            --query "Stacks[0].Outputs[?OutputKey=='FrontendUrl'].OutputValue" \
            --output text 2>/dev/null || echo "CloudFront URL pending")
          
          echo "## ðŸš€ Frontend Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | ${ENVIRONMENT} |" >> $GITHUB_STEP_SUMMARY
          echo "| **URL** | ${FRONTEND_URL} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
# AI Generated Code by Deloitte + Cursor (END)